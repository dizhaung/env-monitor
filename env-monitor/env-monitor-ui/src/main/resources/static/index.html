<!DOCTYPE html>
<html ng-app="EnvMonitor">
<head>
    <title>Angular JS prototype for env-monitor</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <!-- Latest compiled and minified Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Angular -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.5/angular.min.js"></script>

    <script src="ng-stomp.js"></script>

    <script src="sockjs-0.3.4.js"></script>
    <script src="stomp.js"></script>
    <script type="text/javascript">

        'use strict';

        var envMonitor = angular.module('EnvMonitor', ['ngStomp']);
        envMonitor.controller('ApplicationsPageController', ['$stomp', '$scope',
            function ApplicationsPageController($stomp, $scope) {

                $scope.applications = [];

//                        [
//                    {name: 'Application 1', applicationType: 'Type 1'},
//                    {name: 'Application 2', applicationType: 'Type 2'}
//                ];

                $scope.platforms = [];

//                [
//                    {id: "PL-1", name: "Hardcoded Platform 1"},
//                    {id: "PL-2", name: "Hardcoded Platform 2"}
//                ];

                $scope.environments = [];

//                [
//                    {id: "ENV-1", name: "Hardcoded Environment 1"},
//                    {id: "ENV-2", name: "Hardcoded Environment 2"}
//                ];

                $scope.filters = {
                    selectedPlatform: null,
                    selectedEnvironment: null
                };

                $scope.selectedPlatformChanged = function () {
                    var pattern = '/app/modules/M_APPLICATIONS/data/platforms/{platform}/environments';

                    $stomp.subscribe(pattern.replace("{platform}", $scope.filters.selectedPlatform.id),
                            function (msg, headers, res) {
                                $scope.$apply(function () {
                                    $scope.environments = msg.payload.jsonContent;
                                    $scope.filters.selectedEnvironment = $scope.environments[0];

                                    $scope.selectedEnvironmentChanged();

                                });

                                console.log('Call result for environments: ' + JSON.stringify(msg.payload.jsonContent));
                            }, { });

                };

                $scope.selectedEnvironmentChanged = function () {

                    var pattern = '/topic/modules/M_APPLICATIONS/data/platforms/{platformId}/environments/{environmentId}/applications';

                    if (!$scope.filters.selectedPlatform) {
                        return;
                    }

                    if ($scope.currentApplicationsSubscribeId) {
                        //TODO: check order subsc/unsubscr
                        $stomp.unsubscribe($scope.currentApplicationsSubscribeId);
                    }

                    $scope.currentApplicationsSubscribeId = $stomp.subscribe(
                            pattern
                                    .replace("{platformId}",
                                            $scope.filters.selectedPlatform.id)
                                    .replace("{environmentId}",
                                            $scope.filters.selectedEnvironment.id),
                            function (msg, headers, res) {
                                $scope.$apply(function () {
                                    $scope.applications = msg.payload.jsonContent;
                                });

                                console.log('New data for subscription! ' + JSON.stringify(/* $scope.applications */ msg.payload.jsonContent));
                            }, {});

                }


                $stomp.connect('/monitor', [])

                    // frame = CONNECTED headers
                        .then(function (frame) {
                            console.log('Connected!');

                            //TODO create wrapper around $stomp to clearly distinguish CALL and SUBSCRIBE

                            //TODO configure TomCat to catch hot code updates immediately

                            $stomp.subscribe('/app/modules/M_APPLICATIONS/data/platforms', function (msg, headers, res) {
                                $scope.$apply(function () {
                                    $scope.platforms = msg.payload.jsonContent;
                                    $scope.filters.selectedPlatform = $scope.platforms[0];
                                });
                                console.log('Call result for platforms: ' + JSON.stringify(msg.payload.jsonContent));


                                var pattern = '/app/modules/M_APPLICATIONS/data/platforms/{platformId}/environments'
                                $stomp.subscribe(pattern.replace('{platformId}', $scope.filters.selectedPlatform.id),
                                        function (msg, headers, res) {
                                            $scope.$apply(function () {
                                                $scope.environments = msg.payload.jsonContent;
                                                $scope.filters.selectedEnvironment = $scope.environments[0];
                                            });

                                            console.log('Call result for environments: ' + JSON.stringify(msg.payload.jsonContent));

                                            $scope.selectedEnvironmentChanged();

                                        }, { });

                            }, { });

//                            $stomp.subscribe('/topic/modules/M_APPLICATIONS/data/platforms/PLAT1/environments/PL1-ENV1/applications',
//                                    function (msg, headers, res) {
//                                        $scope.$apply(function () {
//                                            $scope.applications = msg.payload.jsonContent;
//                                        });
//
//                                        console.log('New data for subscription! ' + JSON.stringify(/* $scope.applications */ msg.payload.jsonContent));
//                                    }, { });

                        });

            }]
        );

        /*

         var subscription = $stomp.subscribe('/dest', function (payload, headers, res) {
         $scope.payload = payload;
         }, {
         "headers": "are awesome"
         });

         // Unsubscribe
         subscription.unsubscribe();

         // Send message
         $stomp.send('/dest', {
         message: 'body'
         }, {
         priority: 9,
         custom: 42 //Custom Headers
         });

         // Disconnect
         $stomp.disconnect(function () {

         });

         */


    </script>
</head>

<body>

<div class="container-fluid" ng-controller="ApplicationsPageController">

    <div style="padding: 20px">
        <span class="row" id="platforms">
            <div class="col-sm-6">
                <h4>Select platform</h4>
                <select ng-options="platform as platform.name for platform in platforms track by platform.id"
                        ng-change="selectedPlatformChanged()"
                        ng-model="filters.selectedPlatform"
                        id="platformsSelect" class="form-control">


                    <!--option ng-repeat="platform in platforms" ng-selected="selectedPlatformId" ng-model="platform.id">
                        {{platform.name}}
                    </option-->
                </select>
            </div>
            <!--/col-->
        </span>
        <!--/row-->

        <!--div style="padding-top: 20px">{{selectedPlatform.id}}</div-->

        <span class="row" id="environments">
            <div class="col-sm-6">
                <h4>Select environment</h4>
                <select ng-options="environment as environment.name for environment in environments track by environment.id"
                        ng-model="filters.selectedEnvironment"
                        ng-change="selectedEnvironmentChanged()"
                        id="environmentsSelect" class="form-control">
                    <!--option ng-repeat="environment in environments" ng-selected="selectedEnvironmentId"
                            ng-model="environment.id">{{environment.name}}
                    </option-->
                </select>
            </div>
            <!--/col-->
        </span>
        <!--/row-->

        <!--div style="padding-top: 20px">{{selectedEnvironment.id}}</div-->

    </div>


    <table border="1" class="table table-striped">
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Host</th>
            <th>Port</th>
            <th>Url</th>
            <th>Version</th>
            <th>Component name</th>
            <th>Memory (Mb)</th>
            <th>Status</th>
        </tr>
        <tbody>
        <tr ng-repeat="application in applications">
            <td>{{application.name}}</td>
            <td>{{application.applicationType}}</td>
            <td>{{application.host}}</td>
            <td>{{application.port}}</td>
            <td><a ng-href="{{application.url}}">{{application.url}}</a></td>
            <td>{{application.version}}</td>
            <td>{{application.componentName}}</td>
            <td>{{application.processMemory}}</td>
            <td>{{application.status}}</td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>